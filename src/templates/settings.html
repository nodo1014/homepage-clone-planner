{% extends "base.html" %}

{% block content %}
<section class="container">
    <div class="card">
        <h1>API ì„¤ì •</h1>
        <p>í™ˆí˜ì´ì§€ í´ë¡  ê¸°íšì„œ ìƒì„±ê¸°ëŠ” ìœ ë£Œ ë˜ëŠ” ë¬´ë£Œ APIë¥¼ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        {% if message == 'success' %}
        <div class="message success">
            <p><strong>ì„±ê³µ:</strong> ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>
        {% elif message == 'error' %}
        <div class="message error">
            <p><strong>ì˜¤ë¥˜:</strong> ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            {% if detail %}
            <p><small>ìƒì„¸ ì •ë³´: {{ detail }}</small></p>
            {% endif %}
        </div>
        {% endif %}

        <form action="/settings/save" method="post" class="api-settings-form">
            <!-- ì´ë¯¸ì§€ ìƒì„± API ì„¤ì • -->
            <div class="api-setting" x-data="{ mode: '{{ settings.image_gen_mode }}' }">
                <h3>ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± API</h3>
                
                <div class="form-group">
                    <label>API ëª¨ë“œ</label>
                    <div class="grid">
                        <label>
                            <input type="radio" name="image_gen_mode" value="paid" x-model="mode">
                            ìœ ë£Œ (DALL-E 3)
                        </label>
                        <label>
                            <input type="radio" name="image_gen_mode" value="free" x-model="mode">
                            ë¬´ë£Œ (Stable Diffusion)
                        </label>
                    </div>
                </div>
                
                <div x-show="mode === 'paid'">
                    <label for="openai_api_key">
                        OpenAI API Key
                        <input type="password" id="openai_api_key" name="openai_api_key" placeholder="sk-...">
                    </label>
                    <button type="button" class="secondary outline"
                            hx-get="/settings/test/openai"
                            hx-swap="outerHTML"
                            hx-target="next .api-test-result">
                        API í‚¤ í…ŒìŠ¤íŠ¸
                    </button>
                    <div class="api-test-result"></div>
                </div>
                
                <div x-show="mode === 'free'">
                    <label for="local_sd_url">
                        Stable Diffusion ë¡œì»¬ URL
                        <input type="text" id="local_sd_url" name="local_sd_url" value="{{ settings.local_sd_url }}">
                        <small>Stable Diffusion WebUI API ì£¼ì†Œ (ê¸°ë³¸ê°’: http://localhost:7860/sdapi/v1)</small>
                    </label>
                    <button type="button" class="secondary outline"
                            hx-get="/settings/test/sd"
                            hx-swap="outerHTML"
                            hx-target="next .api-test-result">
                        ì—°ê²° í…ŒìŠ¤íŠ¸
                    </button>
                    <div class="api-test-result"></div>
                </div>
            </div>
            
            <!-- ì•„ì´ë””ì–´ ìƒì„± API ì„¤ì • -->
            <div class="api-setting" x-data="{ mode: '{{ settings.idea_gen_mode }}' }">
                <h3>ğŸ’¡ ì•„ì´ë””ì–´ ìƒì„± API</h3>
                
                <div class="form-group">
                    <label>API ëª¨ë“œ</label>
                    <div class="grid">
                        <label>
                            <input type="radio" name="idea_gen_mode" value="paid" x-model="mode">
                            ìœ ë£Œ (DeepSeek)
                        </label>
                        <label>
                            <input type="radio" name="idea_gen_mode" value="free" x-model="mode">
                            ë¬´ë£Œ (Ollama)
                        </label>
                    </div>
                </div>
                
                <div x-show="mode === 'paid'">
                    <label for="deepseek_api_key">
                        DeepSeek API Key
                        <input type="password" id="deepseek_api_key" name="deepseek_api_key" placeholder="dsk-...">
                    </label>
                    <button type="button" class="secondary outline"
                            hx-get="/settings/test/deepseek"
                            hx-swap="outerHTML"
                            hx-target="next .api-test-result">
                        API í‚¤ í…ŒìŠ¤íŠ¸
                    </button>
                    <div class="api-test-result"></div>
                </div>
                
                <div x-show="mode === 'free'">
                    <label for="local_ollama_url">
                        Ollama ë¡œì»¬ URL
                        <input type="text" id="local_ollama_url" name="local_ollama_url" value="{{ settings.local_ollama_url }}">
                        <small>Ollama API ì£¼ì†Œ (ê¸°ë³¸ê°’: http://localhost:11434/api)</small>
                    </label>
                    <label for="ollama_model">
                        Ollama ëª¨ë¸
                        <select id="ollama_model" name="ollama_model">
                            <option value="mistral">Mistral</option>
                            <option value="llama2">Llama 2</option>
                            <option value="llama3">Llama 3</option>
                            <option value="gemma">Gemma</option>
                        </select>
                    </label>
                    <button type="button" class="secondary outline"
                            hx-get="/settings/test/ollama"
                            hx-swap="outerHTML"
                            hx-target="next .api-test-result">
                        ì—°ê²° í…ŒìŠ¤íŠ¸
                    </button>
                    <div class="api-test-result"></div>
                </div>
            </div>
            
            <!-- ì½”ë“œ ìƒì„± API ì„¤ì • -->
            <div class="api-setting" x-data="{ mode: '{{ settings.code_gen_mode }}' }">
                <h3>ğŸ’» ì½”ë“œ ìƒì„± API</h3>
                
                <div class="form-group">
                    <label>API ëª¨ë“œ</label>
                    <div class="grid">
                        <label>
                            <input type="radio" name="code_gen_mode" value="paid" x-model="mode">
                            ìœ ë£Œ (Claude API)
                        </label>
                        <label>
                            <input type="radio" name="code_gen_mode" value="free" x-model="mode">
                            ë¬´ë£Œ (LocalAI)
                        </label>
                    </div>
                </div>
                
                <div x-show="mode === 'paid'">
                    <label for="claude_api_key">
                        Claude API Key
                        <input type="password" id="claude_api_key" name="claude_api_key" placeholder="sk-ant-...">
                    </label>
                    <button type="button" class="secondary outline"
                            hx-get="/settings/test/claude"
                            hx-swap="outerHTML"
                            hx-target="next .api-test-result">
                        API í‚¤ í…ŒìŠ¤íŠ¸
                    </button>
                    <div class="api-test-result"></div>
                </div>
                
                <div x-show="mode === 'free'">
                    <label for="local_code_url">
                        LocalAI URL
                        <input type="text" id="local_code_url" name="local_code_url" value="{{ settings.local_code_url }}">
                        <small>LocalAI API ì£¼ì†Œ (ê¸°ë³¸ê°’: http://localhost:8080/v1)</small>
                    </label>
                    <button type="button" class="secondary outline"
                            hx-get="/settings/test/localai"
                            hx-swap="outerHTML"
                            hx-target="next .api-test-result">
                        ì—°ê²° í…ŒìŠ¤íŠ¸
                    </button>
                    <div class="api-test-result"></div>
                </div>
            </div>
            
            <div class="grid" style="margin-top: 2rem;">
                <div>
                    <button type="submit" class="primary">ì„¤ì • ì €ì¥</button>
                </div>
                <div>
                    <a href="/" role="button" class="secondary outline">í™ˆìœ¼ë¡œ</a>
                </div>
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // API í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì²˜ë¦¬
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.classList.contains('api-test-result')) {
            const response = JSON.parse(event.detail.xhr.responseText);
            
            let resultElement = document.createElement('div');
            resultElement.classList.add('api-test-result');
            
            if (response.status === 'success') {
                resultElement.classList.add('message', 'success');
                resultElement.textContent = response.message;
            } else {
                resultElement.classList.add('message', 'error');
                resultElement.textContent = response.message;
            }
            
            event.detail.target.replaceWith(resultElement);
        }
    });
</script>
{% endblock %} 